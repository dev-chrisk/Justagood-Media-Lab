<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Statistics - Media Library</title>
<link rel="stylesheet" href="styles/style.css">
<style>
    .statistics-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .statistics-header {
        text-align: center;
        margin-bottom: 40px;
    }
    
    .statistics-header h1 {
        color: var(--text-primary);
        margin-bottom: 10px;
    }
    
    .statistics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }
    
    .stat-card {
        background: var(--surface-color);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border-color);
    }
    
    .stat-card h3 {
        color: var(--text-primary);
        margin-bottom: 15px;
        font-size: 1.2em;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 8px;
    }
    
    .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 10px;
    }
    
    .stat-description {
        color: var(--text-secondary);
        font-size: 0.9em;
    }
    
    .chart-container {
        background: var(--surface-color);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border-color);
        margin-bottom: 20px;
    }
    
    .chart-title {
        color: var(--text-primary);
        margin-bottom: 20px;
        font-size: 1.3em;
        text-align: center;
    }
    
    .progress-bar {
        background: var(--surface-hover);
        border-radius: 10px;
        height: 20px;
        margin: 10px 0;
        overflow: hidden;
    }
    
    .progress-fill {
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.8em;
        font-weight: bold;
    }
    
    .category-stats {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .category-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: var(--surface-hover);
        border-radius: 8px;
        border-left: 4px solid var(--primary-color);
    }
    
    .category-name {
        font-weight: bold;
        color: var(--text-primary);
    }
    
    .category-count {
        background: var(--primary-color);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.9em;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }
    
    .error {
        background: #e74c3c;
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        text-align: center;
    }
    
    .refresh-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1em;
        margin-bottom: 20px;
        transition: var(--transition);
    }
    
    .refresh-btn:hover {
        background: var(--secondary-color);
    }
    
    .stats-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
    }
    
    .summary-number {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .summary-label {
        font-size: 0.9em;
        opacity: 0.9;
    }
</style>
</head>
<body>
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2>Media Library</h2>
            <button id="sidebarToggle" class="sidebar-toggle">‚ò∞</button>
        </div>
        
        <div class="sidebar-content">
            <!-- Main Navigation -->
            <div class="sidebar-section">
                <h3>Browse</h3>
                <nav class="sidebar-nav">
                    <a href="index.html" class="nav-btn">
                        <span class="nav-icon">üè†</span>
                        <span class="nav-text">Home</span>
                    </a>
                    <button id="btnGames" class="nav-btn">
                        <span class="nav-icon">üéÆ</span>
                        <span class="nav-text">Games</span>
                        <span id="countGames" class="nav-count">0</span>
                    </button>
                    <button id="btnSeries" class="nav-btn">
                        <span class="nav-icon">üì∫</span>
                        <span class="nav-text">Series</span>
                        <span id="countSeries" class="nav-count">0</span>
                    </button>
                    <button id="btnMovies" class="nav-btn">
                        <span class="nav-icon">üé¨</span>
                        <span class="nav-text">Movies</span>
                        <span id="countMovies" class="nav-count">0</span>
                    </button>
                    <button id="btnGamesNew" class="nav-btn">
                        <span class="nav-icon">üÜï</span>
                        <span class="nav-text">Games New</span>
                    </button>
                    <button id="btnSeriesNew" class="nav-btn">
                        <span class="nav-icon">üÜï</span>
                        <span class="nav-text">Series New</span>
                    </button>
                    <button id="btnMoviesNew" class="nav-btn">
                        <span class="nav-icon">üÜï</span>
                        <span class="nav-text">Movies New</span>
                    </button>
                    <button id="btnCalendar" class="nav-btn">
                        <span class="nav-icon">üìÖ</span>
                        <span class="nav-text">Calendar</span>
                    </button>
                    <a href="statistics.html" class="nav-btn active">
                        <span class="nav-icon">üìä</span>
                        <span class="nav-text">Statistics</span>
                    </a>
                </nav>
            </div>

            <!-- Filters Section -->
            <div class="sidebar-section">
                <h3>Filters</h3>
                <div class="filter-section">
                    <div class="filter-group">
                        <h4>Platforms</h4>
                        <div id="platformFilters" class="filter-checkboxes">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    <div class="filter-group">
                        <h4>Genres</h4>
                        <div id="genreFilters" class="filter-checkboxes">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    <div class="filter-group">
                        <h4>Other Options</h4>
                        <div class="filter-options">
                            <label class="filter-option">
                                <input type="checkbox" id="landscapeMode">
                                <span class="checkmark"></span>
                                <span class="option-text">Landscape Mode</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Section -->
            <div class="sidebar-section">
                <h3>Account</h3>
                <div id="authButtons" class="auth-buttons">
                    <button id="loginBtn" class="auth-btn">Login</button>
                    <button id="registerBtn" class="auth-btn">Register</button>
                </div>
                <div id="userInfo" class="user-info" style="display: none;">
                    <div class="user-profile">
                        <span id="userName" class="user-name"></span>
                        <button id="accountBtn" class="account-btn">‚öôÔ∏è</button>
                    </div>
                    <button id="logoutBtn" class="auth-btn">Logout</button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="statistics-container">
            <div class="statistics-header">
                <h1>üìä Media Library Statistics</h1>
                <p>√úbersicht √ºber deine Media Collection</p>
                <div style="display: flex; gap: 10px; justify-content: center; align-items: center; margin-top: 15px;">
                    <button id="refreshStats" class="refresh-btn">üîÑ Refresh Statistics</button>
                    <button id="darkModeToggle" class="refresh-btn" style="background: var(--surface-color); color: var(--text-primary); border: 1px solid var(--border-color);">üåô Dark Mode</button>
                </div>
            </div>

            <div id="loadingMessage" class="loading">
                <p>Lade Statistiken...</p>
            </div>

            <div id="errorMessage" class="error" style="display: none;">
                <p>Fehler beim Laden der Statistiken. Bitte versuche es erneut.</p>
            </div>

            <div id="statisticsContent" style="display: none;">
                <!-- Summary Cards -->
                <div class="stats-summary">
                    <div class="summary-card">
                        <div class="summary-number" id="totalItems">0</div>
                        <div class="summary-label">Total Items</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number" id="totalCollections">0</div>
                        <div class="summary-label">Collections</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number" id="totalPlaytime">0h</div>
                        <div class="summary-label">Total Playtime</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number" id="avgRating">0.0</div>
                        <div class="summary-label">Avg Rating</div>
                    </div>
                </div>

                <!-- Category Distribution -->
                <div class="chart-container">
                    <h3 class="chart-title">üìà Category Distribution</h3>
                    <div id="categoryChart" class="category-stats">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Rating Distribution -->
                <div class="chart-container">
                    <h3 class="chart-title">‚≠ê Rating Distribution</h3>
                    <div id="ratingChart">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Platform Distribution -->
                <div class="chart-container">
                    <h3 class="chart-title">üéÆ Platform Distribution</h3>
                    <div id="platformChart">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Genre Distribution -->
                <div class="chart-container">
                    <h3 class="chart-title">üé≠ Top Genres</h3>
                    <div id="genreChart">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="chart-container">
                    <h3 class="chart-title">üìÖ Recent Activity</h3>
                    <div id="recentActivity">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Airing Series -->
                <div class="chart-container">
                    <h3 class="chart-title">üì∫ Currently Airing Series</h3>
                    <div id="airingSeries">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="scripts/app.js"></script>
    <script src="scripts/script.js"></script>
    <script>
        // Statistics functionality
        class StatisticsManager {
            constructor() {
                this.stats = {};
                this.init();
            }

            async init() {
                await this.loadStatistics();
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('refreshStats').addEventListener('click', () => {
                    this.loadStatistics();
                });
                
                // Dark mode toggle
                const darkModeToggle = document.getElementById('darkModeToggle');
                if (darkModeToggle) {
                    darkModeToggle.addEventListener('click', () => {
                        if (typeof toggleDarkMode === 'function') {
                            toggleDarkMode();
                        }
                    });
                }
            }

            async loadStatistics() {
                try {
                    this.showLoading();
                    
                    // Load all statistics in parallel
                    const [
                        totalStats,
                        categoryStats,
                        ratingStats,
                        platformStats,
                        genreStats,
                        recentActivity,
                        airingSeries
                    ] = await Promise.all([
                        this.fetchTotalStats(),
                        this.fetchCategoryStats(),
                        this.fetchRatingStats(),
                        this.fetchPlatformStats(),
                        this.fetchGenreStats(),
                        this.fetchRecentActivity(),
                        this.fetchAiringSeries()
                    ]);

                    this.stats = {
                        total: totalStats,
                        categories: categoryStats,
                        ratings: ratingStats,
                        platforms: platformStats,
                        genres: genreStats,
                        recent: recentActivity,
                        airing: airingSeries
                    };

                    this.renderStatistics();
                    this.hideLoading();
                } catch (error) {
                    console.error('Error loading statistics:', error);
                    this.showError();
                }
            }

            async fetchTotalStats() {
                const response = await fetch('/api/statistics/total');
                return await response.json();
            }

            async fetchCategoryStats() {
                const response = await fetch('/api/statistics/categories');
                return await response.json();
            }

            async fetchRatingStats() {
                const response = await fetch('/api/statistics/ratings');
                return await response.json();
            }

            async fetchPlatformStats() {
                const response = await fetch('/api/statistics/platforms');
                return await response.json();
            }

            async fetchGenreStats() {
                const response = await fetch('/api/statistics/genres');
                return await response.json();
            }

            async fetchRecentActivity() {
                const response = await fetch('/api/statistics/recent');
                return await response.json();
            }

            async fetchAiringSeries() {
                const response = await fetch('/api/statistics/airing');
                return await response.json();
            }

            renderStatistics() {
                this.renderSummaryCards();
                this.renderCategoryChart();
                this.renderRatingChart();
                this.renderPlatformChart();
                this.renderGenreChart();
                this.renderRecentActivity();
                this.renderAiringSeries();
            }

            renderSummaryCards() {
                document.getElementById('totalItems').textContent = this.stats.total.totalItems || 0;
                document.getElementById('totalCollections').textContent = this.stats.total.totalCollections || 0;
                document.getElementById('totalPlaytime').textContent = this.formatPlaytime(this.stats.total.totalPlaytime || 0);
                document.getElementById('avgRating').textContent = (this.stats.total.avgRating || 0).toFixed(1);
            }

            renderCategoryChart() {
                const container = document.getElementById('categoryChart');
                container.innerHTML = '';

                if (this.stats.categories && this.stats.categories.length > 0) {
                    const maxCount = Math.max(...this.stats.categories.map(cat => cat.count));
                    
                    this.stats.categories.forEach(category => {
                        const percentage = (category.count / maxCount) * 100;
                        const item = document.createElement('div');
                        item.className = 'category-item';
                        item.innerHTML = `
                            <span class="category-name">${category.category}</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%">
                                    ${category.count}
                                </div>
                            </div>
                        `;
                        container.appendChild(item);
                    });
                }
            }

            renderRatingChart() {
                const container = document.getElementById('ratingChart');
                container.innerHTML = '';

                if (this.stats.ratings && this.stats.ratings.length > 0) {
                    const maxCount = Math.max(...this.stats.ratings.map(rating => rating.count));
                    
                    this.stats.ratings.forEach(rating => {
                        const percentage = (rating.count / maxCount) * 100;
                        const item = document.createElement('div');
                        item.className = 'category-item';
                        item.innerHTML = `
                            <span class="category-name">${rating.rating} ‚≠ê</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%">
                                    ${rating.count}
                                </div>
                            </div>
                        `;
                        container.appendChild(item);
                    });
                }
            }

            renderPlatformChart() {
                const container = document.getElementById('platformChart');
                container.innerHTML = '';

                if (this.stats.platforms && this.stats.platforms.length > 0) {
                    const maxCount = Math.max(...this.stats.platforms.map(platform => platform.count));
                    
                    this.stats.platforms.forEach(platform => {
                        const percentage = (platform.count / maxCount) * 100;
                        const item = document.createElement('div');
                        item.className = 'category-item';
                        item.innerHTML = `
                            <span class="category-name">${platform.platform}</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%">
                                    ${platform.count}
                                </div>
                            </div>
                        `;
                        container.appendChild(item);
                    });
                }
            }

            renderGenreChart() {
                const container = document.getElementById('genreChart');
                container.innerHTML = '';

                if (this.stats.genres && this.stats.genres.length > 0) {
                    const maxCount = Math.max(...this.stats.genres.map(genre => genre.count));
                    
                    this.stats.genres.slice(0, 10).forEach(genre => {
                        const percentage = (genre.count / maxCount) * 100;
                        const item = document.createElement('div');
                        item.className = 'category-item';
                        item.innerHTML = `
                            <span class="category-name">${genre.genre}</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%">
                                    ${genre.count}
                                </div>
                            </div>
                        `;
                        container.appendChild(item);
                    });
                }
            }

            renderRecentActivity() {
                const container = document.getElementById('recentActivity');
                container.innerHTML = '';

                if (this.stats.recent && this.stats.recent.length > 0) {
                    this.stats.recent.forEach(activity => {
                        const item = document.createElement('div');
                        item.className = 'category-item';
                        item.innerHTML = `
                            <span class="category-name">${activity.title}</span>
                            <span class="category-count">${this.formatDate(activity.discovered)}</span>
                        `;
                        container.appendChild(item);
                    });
                }
            }

            renderAiringSeries() {
                const container = document.getElementById('airingSeries');
                container.innerHTML = '';

                if (this.stats.airing && this.stats.airing.length > 0) {
                    this.stats.airing.forEach(series => {
                        const item = document.createElement('div');
                        item.className = 'category-item';
                        item.innerHTML = `
                            <span class="category-name">${series.title}</span>
                            <span class="category-count">S${series.next_season}</span>
                        `;
                        container.appendChild(item);
                    });
                }
            }

            formatPlaytime(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours}h ${mins}m`;
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('de-DE');
            }

            showLoading() {
                document.getElementById('loadingMessage').style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('statisticsContent').style.display = 'none';
            }

            hideLoading() {
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('statisticsContent').style.display = 'block';
            }

            showError() {
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('statisticsContent').style.display = 'none';
            }
        }

        // Initialize statistics when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new StatisticsManager();
            
            // Initialize dark mode if available
            if (typeof initializeDarkMode === 'function') {
                initializeDarkMode();
            }
            
            // Update dark mode button text
            updateDarkModeButton();
        });
        
        // Function to update dark mode button text
        function updateDarkModeButton() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                const isDarkMode = document.documentElement.classList.contains('dark-mode');
                darkModeToggle.textContent = isDarkMode ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
            }
        }
        
        // Listen for dark mode changes
        document.addEventListener('darkModeChanged', updateDarkModeButton);
    </script>
</body>
</html>
