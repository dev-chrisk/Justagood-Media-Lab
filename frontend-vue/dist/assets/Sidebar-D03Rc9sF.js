import{G as X,d as P,r as b,l as O,c as _,y as S,_ as N,b as k,e as n,t as M,o as C,D as $,F as Y,x as Z,n as A,H as B,z as x}from"./index-DL2gJxAr.js";class ee{constructor(){this.isConnected={value:!1},this.listeners=new Map,this.pollingInterval=null,this.lastUpdate=null,this.pollingIntervalMs=2e4}getApiBaseUrl(){return X.BASE_URL}connect(){if(this.pollingInterval)return;const s=localStorage.getItem("authToken"),c=localStorage.getItem("currentUser");!s||!c||(this.isConnected.value=!0,this.lastUpdate=new Date,this.pollingInterval=setInterval(()=>{this.checkForUpdates()},this.pollingIntervalMs))}async checkForUpdates(){try{const s=localStorage.getItem("authToken"),c=localStorage.getItem("currentUser");if(!s||!c)return;const v=this.getApiBaseUrl(),a=await fetch(`${v}/api/media`,{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}});if(!a.ok){if(a.status===401){this.disconnect();return}throw new Error(`HTTP error! status: ${a.status}`)}const d=await a.json();d&&d.length>0&&this.listeners.forEach((f,I)=>{try{f({type:"media_updated",items:d,count:d.length,timestamp:new Date().toISOString()})}catch{}}),this.lastUpdate=new Date}catch{}}addListener(s,c){this.listeners.set(s,c)}removeListener(s){this.listeners.delete(s)}disconnect(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null),this.isConnected.value=!1}destroy(){this.disconnect(),this.listeners.clear()}}const L=new ee,Ce=P("media",()=>{const g=()=>{try{return localStorage.getItem("currentCategory")||"game"}catch(e){return console.error("Failed to load current category from localStorage:",e),"game"}},s=e=>{try{localStorage.setItem("currentCategory",e)}catch(t){console.error("Failed to save current category to localStorage:",t)}},c=()=>{try{return localStorage.getItem("searchQuery")||""}catch(e){return console.error("Failed to load search query from localStorage:",e),""}},v=e=>{try{localStorage.setItem("searchQuery",e)}catch(t){console.error("Failed to save search query to localStorage:",t)}},a=b(w()),d=b(g()),f=b(c()),I=b(!1),l=b(null);O(d,e=>{s(e)},{immediate:!1}),O(f,e=>{v(e)},{immediate:!1});function w(){try{const e=localStorage.getItem("authToken"),t=localStorage.getItem("currentUser");if(!e||!t){const o=localStorage.getItem("mediaData");return o?JSON.parse(o):[]}return[]}catch(e){return console.error("Failed to load media from storage:",e),[]}}function y(){try{const e=localStorage.getItem("authToken"),t=localStorage.getItem("currentUser");(!e||!t)&&localStorage.setItem("mediaData",JSON.stringify(a.value))}catch(e){console.error("Failed to save media to storage:",e)}}const D=_(()=>a.value.length),E=_(()=>{const e={};return a.value.forEach(t=>{const o=t.category||"unknown";e[o]=(e[o]||0)+1}),e}),m=_(()=>{let e=[...a.value];if(d.value&&d.value!=="all"&&(e=e.filter(t=>d.value==="watchlist"?t.category==="watchlist"||t.isNew===!0:t.category===d.value)),f.value){const t=f.value.toLowerCase();e=e.filter(o=>{var i,r,u,U;return((i=o.title)==null?void 0:i.toLowerCase().includes(t))||((r=o.description)==null?void 0:r.toLowerCase().includes(t))||((u=o.genre)==null?void 0:u.toLowerCase().includes(t))||((U=o.platforms)==null?void 0:U.toLowerCase().includes(t))})}return e});async function p(){var e,t;I.value=!0,l.value=null;try{const o=localStorage.getItem("authToken"),i=localStorage.getItem("currentUser");if(o&&i)try{const r=await S.getMedia();console.log("🔍 LOAD DEBUG: API returned data:",r),console.log("🔍 LOAD DEBUG: Data length:",r==null?void 0:r.length),console.log("🔍 LOAD DEBUG: First item:",r==null?void 0:r[0]),a.value=r||[],console.log("🔍 LOAD DEBUG: mediaData.value set to:",a.value)}catch(r){console.warn("API load failed for logged in user:",r),a.value=[]}else{const r=w();if(r.length>0)a.value=r;else{const u=await S.getMedia();a.value=u||[],y()}}}catch(o){l.value=((t=(e=o.response)==null?void 0:e.data)==null?void 0:t.message)||o.message||"Failed to load media data",console.error("Failed to load media:",o)}finally{I.value=!1}}function R(e){d.value=e}function G(e){f.value=e}async function Q(e,t=!1){var o,i,r;l.value=null;try{const u=localStorage.getItem("authToken"),U=localStorage.getItem("currentUser");if(u&&U)try{const h=await S.addMediaItem(e);if(!t)await p();else{const F={...h,__order:a.value.length};a.value.push(F)}return h}catch(h){if(((o=h.response)==null?void 0:o.status)===409&&((r=(i=h.response)==null?void 0:i.data)!=null&&r.duplicate)){const F=new Error(h.response.data.error||"Ein Eintrag mit diesem Titel und dieser Kategorie existiert bereits.");throw F.isDuplicate=!0,F}throw l.value=h.message||"Failed to add media item",console.error("API save failed for logged in user:",h),h}else{const h={id:Date.now(),...e,__order:a.value.length};return a.value.push(h),y(),h}}catch(u){throw u}}async function z(e,t){l.value=null;try{const o=localStorage.getItem("authToken"),i=localStorage.getItem("currentUser");if(o&&i)try{const r=await S.updateMediaItem(e,t);return await p(),r}catch(r){throw console.error("API update failed for logged in user:",r),r}else{const r=a.value.findIndex(u=>u.id===e);if(r!==-1)return a.value[r]={...a.value[r],...t},y(),a.value[r];throw new Error("Media item not found")}}catch(o){throw o.isDuplicate||(l.value=o.message||"Failed to update media item"),o}}async function V(e){var t;try{const o=localStorage.getItem("authToken"),i=localStorage.getItem("currentUser");if(o&&i)try{return await S.deleteMediaItem(e),await p(),!0}catch(r){if(((t=r.response)==null?void 0:t.status)===404||r.isNotFound)return await p(),!0;throw console.error("API delete failed for logged in user:",r),r}else{const r=a.value.findIndex(u=>u.id===e);if(r!==-1)return a.value.splice(r,1),y(),!0;throw new Error("Media item not found")}}catch(o){throw l.value=o.message||"Failed to delete media item",o}}async function J(e){try{const t=localStorage.getItem("authToken"),o=localStorage.getItem("currentUser");if(t&&o)try{const i=await S.batchAddMediaItems(e);return await p(),i}catch(i){throw console.error("API batch add failed for logged in user:",i),i}else{const i=e.map((r,u)=>({id:Date.now()+u,...r,__order:a.value.length+u}));return a.value.push(...i),y(),{success:!0,stats:{created:i.length,failed:0,errors:[]}}}}catch(t){throw l.value=t.message||"Failed to add media items",t}}async function j(e){try{const t=localStorage.getItem("authToken"),o=localStorage.getItem("currentUser");if(t&&o)try{return await S.batchDeleteMediaItems(e),await p(),!0}catch(i){if(i.silent)return console.log("Silent batch delete error (some items may not exist):",i.message),await p(),!0;throw console.error("API batch delete failed for logged in user:",i),i}else return a.value=a.value.filter(i=>!e.includes(i.id)),y(),!0}catch(t){throw t.silent||(l.value=t.message||"Failed to delete media items"),t}}async function q(){try{const e=localStorage.getItem("authToken"),t=localStorage.getItem("currentUser");e&&t?await S.saveMedia(a.value):y()}catch(e){console.error("Failed to save media:",e)}}function T(){l.value=null}function H(e){if(console.log("Processing real-time update:",e),e.type==="media_updated"&&e.items)e.items.forEach(t=>{const o=a.value.findIndex(i=>i.id===t.id);o!==-1?a.value[o]={...a.value[o],...t}:a.value.push(t)});else if(e.action==="created"||e.action==="updated"){const t=e.item,o=a.value.findIndex(i=>i.id===t.id);o!==-1?a.value[o]={...a.value[o],...t}:a.value.push(t)}else if(e.action==="deleted"){const t=a.value.findIndex(o=>o.id===e.id);t!==-1&&a.value.splice(t,1)}y()}function W(){const e=localStorage.getItem("authToken"),t=localStorage.getItem("currentUser");if(!e||!t){console.log("Skipping realtime initialization - user not authenticated");return}try{L.addListener("media-store",H),L.connect()}catch(o){console.error("Failed to initialize realtime updates:",o)}}function K(){L.removeListener("media-store")}return{mediaData:a,currentCategory:d,searchQuery:f,loading:I,error:l,totalItems:D,categoryCounts:E,filteredMedia:m,loadMedia:p,setCategory:R,setSearchQuery:G,addMediaItem:Q,updateMediaItem:z,deleteMediaItem:V,batchAddMediaItems:J,batchDeleteMediaItems:j,saveMedia:q,clearError:T,initializeRealtimeUpdates:W,cleanupRealtimeUpdates:K,resetMediaState:()=>{d.value="game",f.value="",localStorage.removeItem("currentCategory"),localStorage.removeItem("searchQuery")}}}),Me=P("sidebar",()=>{const g=()=>{try{const m=localStorage.getItem("sidebarState");if(m)return{collapsed:JSON.parse(m).collapsed||!1,mobileOpen:!1}}catch(m){console.error("Failed to load sidebar state from localStorage:",m)}return{collapsed:!1,mobileOpen:!1}},s=m=>{try{localStorage.setItem("sidebarState",JSON.stringify({collapsed:m.collapsed}))}catch(p){console.error("Failed to save sidebar state to localStorage:",p)}},c=g(),v=b(c.collapsed),a=b(c.mobileOpen);O(v,m=>{s({collapsed:m,mobileOpen:a.value})},{immediate:!1});const d=()=>{v.value=!v.value},f=()=>{a.value=!a.value},I=()=>{a.value=!1},l=m=>{v.value=m},w=m=>{a.value=m},y=()=>{v.value=!1,a.value=!1,localStorage.removeItem("sidebarState")},D=_(()=>v.value),E=_(()=>a.value);return{collapsed:v,mobileOpen:a,toggleSidebar:d,toggleMobileSidebar:f,closeMobileSidebar:I,setCollapsed:l,setMobileOpen:w,resetSidebarState:y,isCollapsed:D,isMobileOpen:E}}),te={name:"VersionInfo",data(){return{version:"1.0.0"}}},ae={class:"version-info"},oe={class:"version-label"};function se(g,s,c,v,a,d){return C(),k("div",ae,[n("span",oe,"Build #"+M(a.version),1)])}const re=N(te,[["render",se],["__scopeId","data-v-2d54e3c7"]]),ne={name:"Sidebar",components:{VersionInfo:re},props:{collapsed:{type:Boolean,default:!1},mobileOpen:{type:Boolean,default:!1},isLoggedIn:{type:Boolean,default:!1},userName:{type:String,default:""},currentCategory:{type:String,default:"watchlist"},categoryCounts:{type:Object,default:()=>({})},categories:{type:Array,default:()=>[{key:"game",name:"Games",icon:"🎮"},{key:"series",name:"Series",icon:"📺"},{key:"movie",name:"Movies",icon:"🎬"},{key:"buecher",name:"Bücher",icon:"📚"},{key:"watchlist",name:"Watchlist",icon:"❤️"}]}},emits:["toggle","setCategory","addItem","navigateToCalendar","navigateToProfile","showLogin","showRegister","logout"],methods:{}},le={class:"sidebar-content"},ie={class:"sidebar-section"},ce={class:"sidebar-nav"},de=["onClick"],ue={class:"nav-icon"},ge={class:"nav-text"},me={class:"nav-count"},ve=["onClick","title"],fe={class:"sidebar-section"},he={key:0,class:"auth-buttons"},pe={key:1,class:"user-info"},ye={class:"user-profile"},Ie={class:"profile-details"},Se={class:"user-name"};function be(g,s,c,v,a,d){const f=x("router-link"),I=x("VersionInfo");return C(),k("aside",{id:"sidebar",class:A(["sidebar",{collapsed:c.collapsed,open:c.mobileOpen}])},[n("div",{class:"sidebar-header",onClick:s[0]||(s[0]=l=>g.$emit("toggle"))},[...s[6]||(s[6]=[n("h2",null,"Media Library",-1),n("button",{class:"sidebar-toggle"},"☰",-1)])]),n("div",le,[n("div",ie,[s[11]||(s[11]=n("h3",null,"Browse",-1)),n("nav",ce,[(C(!0),k(Y,null,Z(c.categories,l=>(C(),k("div",{key:l.key,class:"nav-item"},[n("button",{class:A(["nav-btn",{active:c.currentCategory===l.key}]),onClick:w=>g.$emit("setCategory",l.key)},[n("span",ue,M(l.icon),1),n("span",ge,M(l.name),1),n("span",me,M(c.categoryCounts[l.key]||0),1)],10,de),n("button",{class:"add-btn",onClick:w=>g.$emit("addItem",l.key),title:`Add ${l.name}`},[...s[7]||(s[7]=[n("span",{class:"add-icon"},"+",-1)])],8,ve)]))),128)),n("button",{class:A(["nav-btn",{active:c.currentCategory==="statistics"}]),onClick:s[1]||(s[1]=l=>g.$emit("setCategory","statistics"))},[...s[8]||(s[8]=[n("span",{class:"nav-icon"},"📊",-1),n("span",{class:"nav-text"},"Statistics",-1)])],2),$(f,{to:"/calendar",class:"nav-btn"},{default:B(()=>[...s[9]||(s[9]=[n("span",{class:"nav-icon"},"📅",-1),n("span",{class:"nav-text"},"Calendar",-1)])]),_:1}),$(f,{to:"/profile",class:"nav-btn"},{default:B(()=>[...s[10]||(s[10]=[n("span",{class:"nav-icon"},"👤",-1),n("span",{class:"nav-text"},"Profile",-1)])]),_:1})])]),n("div",fe,[s[13]||(s[13]=n("h3",null,"Account",-1)),c.isLoggedIn?(C(),k("div",pe,[n("div",ye,[s[12]||(s[12]=n("div",{class:"profile-avatar"},[n("span",{class:"avatar-text"},"👤")],-1)),n("div",Ie,[n("span",Se,M(c.userName),1)]),n("button",{class:"account-btn",onClick:s[4]||(s[4]=l=>g.$emit("navigateToProfile"))},"⚙️")]),n("button",{class:"auth-btn",onClick:s[5]||(s[5]=l=>g.$emit("logout"))},"Logout")])):(C(),k("div",he,[n("button",{class:"auth-btn",onClick:s[2]||(s[2]=l=>g.$emit("showLogin"))},"Login"),n("button",{class:"auth-btn",onClick:s[3]||(s[3]=l=>g.$emit("showRegister"))},"Register")]))])]),$(I)],2)}const _e=N(ne,[["render",be],["__scopeId","data-v-5262d208"]]);export{_e as S,Me as a,Ce as u};
