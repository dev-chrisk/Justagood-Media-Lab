import{d as Y,r as S,c as C,q as k,_ as $,b as p,e as n,t as b,o as h,z as F,f as Z,F as x,p as A,E as _,B as T,g as ee,n as U}from"./index-DeAROFQM.js";class te{constructor(){this.isConnected={value:!1},this.listeners=new Map,this.pollingInterval=null,this.lastUpdate=null,this.pollingIntervalMs=2e4}getApiBaseUrl(){return"https://teabubble.attrebi.ch"}connect(){if(this.pollingInterval)return;const t=localStorage.getItem("authToken"),c=localStorage.getItem("currentUser");!t||!c||(this.isConnected.value=!0,this.lastUpdate=new Date,this.pollingInterval=setInterval(()=>{this.checkForUpdates()},this.pollingIntervalMs))}async checkForUpdates(){try{const t=localStorage.getItem("authToken"),c=localStorage.getItem("currentUser");if(!t||!c)return;const f=this.getApiBaseUrl(),v=await fetch(`${f}/api/media`,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(!v.ok){if(v.status===401){this.disconnect();return}throw new Error(`HTTP error! status: ${v.status}`)}const u=await v.json();u&&u.length>0&&this.listeners.forEach((y,m)=>{try{y({type:"media_updated",items:u,count:u.length,timestamp:new Date().toISOString()})}catch{}}),this.lastUpdate=new Date}catch{}}addListener(t,c){this.listeners.set(t,c)}removeListener(t){this.listeners.delete(t)}disconnect(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null),this.isConnected.value=!1}destroy(){this.disconnect(),this.listeners.clear()}}const L=new te,Ne=Y("media",()=>{const o=S(y()),t=S("game"),c=S(""),f=S([]),v=S(!1),u=S(null);function y(){try{const e=localStorage.getItem("authToken"),a=localStorage.getItem("currentUser");if(!e||!a){const s=localStorage.getItem("mediaData");return s?JSON.parse(s):[]}return[]}catch(e){return console.error("Failed to load media from storage:",e),[]}}function m(){try{const e=localStorage.getItem("authToken"),a=localStorage.getItem("currentUser");(!e||!a)&&localStorage.setItem("mediaData",JSON.stringify(o.value))}catch(e){console.error("Failed to save media to storage:",e)}}const l=C(()=>o.value.length),I=C(()=>{const e={};return o.value.forEach(a=>{const s=a.category||"unknown";e[s]=(e[s]||0)+1}),e}),B=C(()=>{let e=[...o.value];if(t.value&&t.value!=="all"&&(e=e.filter(a=>t.value==="watchlist"?a.category==="watchlist"||a.isNew===!0:a.category===t.value)),c.value){const a=c.value.toLowerCase();e=e.filter(s=>{var r,i,g,d;return((r=s.title)==null?void 0:r.toLowerCase().includes(a))||((i=s.description)==null?void 0:i.toLowerCase().includes(a))||((g=s.genre)==null?void 0:g.toLowerCase().includes(a))||((d=s.platforms)==null?void 0:d.toLowerCase().includes(a))})}return f.value.forEach(a=>{a.type==="platform"?e=e.filter(s=>{var r;return(r=s.platforms)==null?void 0:r.toLowerCase().includes(a.value.toLowerCase())}):a.type==="genre"?e=e.filter(s=>{var r;return(r=s.genre)==null?void 0:r.toLowerCase().includes(a.value.toLowerCase())}):a.type==="airing"&&(a.value==="airing"?e=e.filter(s=>s.isAiring===!0):a.value==="finished"&&(e=e.filter(s=>s.isAiring===!1||s.isAiring===null)))}),e}),P=C(()=>{const e=new Set;return o.value.forEach(a=>{a.platforms&&a.platforms.split(/[,;|&]/).map(r=>r.trim()).filter(r=>r.length>0).forEach(r=>e.add(r))}),Array.from(e).sort()}),D=C(()=>{const e=new Set;return o.value.forEach(a=>{a.genre&&a.genre.split(/[,;|&]/).map(r=>r.trim()).filter(r=>r.length>0).forEach(r=>e.add(r))}),Array.from(e).sort()});async function w(){var e,a;v.value=!0,u.value=null;try{const s=localStorage.getItem("authToken"),r=localStorage.getItem("currentUser");if(s&&r)try{const i=await k.getMedia();o.value=i||[]}catch(i){console.warn("API load failed for logged in user:",i),o.value=[]}else{const i=y();if(i.length>0)o.value=i;else{const g=await k.getMedia();o.value=g||[],m()}}}catch(s){u.value=((a=(e=s.response)==null?void 0:e.data)==null?void 0:a.message)||s.message||"Failed to load media data",console.error("Failed to load media:",s)}finally{v.value=!1}}function N(e){t.value=e}function V(e){c.value=e}function R(e){f.value.some(s=>s.type===e.type&&s.value===e.value)||f.value.push(e)}function z(e){f.value=f.value.filter(a=>!(a.type===e.type&&a.value===e.value))}function O(){f.value=[]}async function G(e){var a,s,r;u.value=null;try{const i=localStorage.getItem("authToken"),g=localStorage.getItem("currentUser");if(i&&g)try{const d=await k.addMediaItem(e);return await w(),d}catch(d){if(((a=d.response)==null?void 0:a.status)===409&&((r=(s=d.response)==null?void 0:s.data)!=null&&r.duplicate)){const E=new Error(d.response.data.error||"Ein Eintrag mit diesem Titel und dieser Kategorie existiert bereits.");throw E.isDuplicate=!0,E}throw u.value=d.message||"Failed to add media item",console.error("API save failed for logged in user:",d),d}else{const d={id:Date.now(),...e,__order:o.value.length};return o.value.push(d),m(),d}}catch(i){throw i}}async function j(e,a){u.value=null;try{const s=localStorage.getItem("authToken"),r=localStorage.getItem("currentUser");if(s&&r)try{const i=await k.updateMediaItem(e,a);return await w(),i}catch(i){throw console.error("API update failed for logged in user:",i),i}else{const i=o.value.findIndex(g=>g.id===e);if(i!==-1)return o.value[i]={...o.value[i],...a},m(),o.value[i];throw new Error("Media item not found")}}catch(s){throw s.isDuplicate||(u.value=s.message||"Failed to update media item"),s}}async function q(e){var a;try{const s=localStorage.getItem("authToken"),r=localStorage.getItem("currentUser");if(s&&r)try{return await k.deleteMediaItem(e),await w(),!0}catch(i){if(((a=i.response)==null?void 0:a.status)===404||i.isNotFound)return await w(),!0;throw console.error("API delete failed for logged in user:",i),i}else{const i=o.value.findIndex(g=>g.id===e);if(i!==-1)return o.value.splice(i,1),m(),!0;throw new Error("Media item not found")}}catch(s){throw u.value=s.message||"Failed to delete media item",s}}async function J(e){try{const a=localStorage.getItem("authToken"),s=localStorage.getItem("currentUser");if(a&&s)try{const r=await k.batchAddMediaItems(e);return await w(),r}catch(r){throw console.error("API batch add failed for logged in user:",r),r}else{const r=e.map((i,g)=>({id:Date.now()+g,...i,__order:o.value.length+g}));return o.value.push(...r),m(),{success:!0,stats:{created:r.length,failed:0,errors:[]}}}}catch(a){throw u.value=a.message||"Failed to add media items",a}}async function Q(e){try{const a=localStorage.getItem("authToken"),s=localStorage.getItem("currentUser");if(a&&s)try{return await k.batchDeleteMediaItems(e),await w(),!0}catch(r){throw console.error("API batch delete failed for logged in user:",r),r}else return o.value=o.value.filter(r=>!e.includes(r.id)),m(),!0}catch(a){throw u.value=a.message||"Failed to delete media items",a}}async function H(){try{const e=localStorage.getItem("authToken"),a=localStorage.getItem("currentUser");e&&a?await k.saveMedia(o.value):m()}catch(e){console.error("Failed to save media:",e)}}function M(){u.value=null}function K(e){if(console.log("Processing real-time update:",e),e.type==="media_updated"&&e.items)e.items.forEach(a=>{const s=o.value.findIndex(r=>r.id===a.id);s!==-1?o.value[s]={...o.value[s],...a}:o.value.push(a)});else if(e.action==="created"||e.action==="updated"){const a=e.item,s=o.value.findIndex(r=>r.id===a.id);s!==-1?o.value[s]={...o.value[s],...a}:o.value.push(a)}else if(e.action==="deleted"){const a=o.value.findIndex(s=>s.id===e.id);a!==-1&&o.value.splice(a,1)}m()}function W(){const e=localStorage.getItem("authToken"),a=localStorage.getItem("currentUser");if(!e||!a){console.log("Skipping realtime initialization - user not authenticated");return}try{L.addListener("media-store",K),L.connect()}catch(s){console.error("Failed to initialize realtime updates:",s)}}function X(){L.removeListener("media-store")}return{mediaData:o,currentCategory:t,searchQuery:c,activeFilters:f,loading:v,error:u,totalItems:l,categoryCounts:I,filteredMedia:B,platforms:P,genres:D,loadMedia:w,setCategory:N,setSearchQuery:V,addFilter:R,removeFilter:z,clearFilters:O,addMediaItem:G,updateMediaItem:j,deleteMediaItem:q,batchAddMediaItems:J,batchDeleteMediaItems:Q,saveMedia:H,clearError:M,initializeRealtimeUpdates:W,cleanupRealtimeUpdates:X}}),ae={name:"VersionInfo",data(){return{version:"1.0.0"}}},se={class:"version-info"},ne={class:"version-label"};function oe(o,t,c,f,v,u){return h(),p("div",se,[n("span",ne,"Build #"+b(v.version),1)])}const re=$(ae,[["render",oe],["__scopeId","data-v-2d54e3c7"]]),ie={name:"Sidebar",components:{VersionInfo:re},props:{collapsed:{type:Boolean,default:!1},mobileOpen:{type:Boolean,default:!1},isLoggedIn:{type:Boolean,default:!1},userName:{type:String,default:""},currentCategory:{type:String,default:"watchlist"},categoryCounts:{type:Object,default:()=>({})},platforms:{type:Array,default:()=>[]},genres:{type:Array,default:()=>[]},categories:{type:Array,default:()=>[{key:"game",name:"Games",icon:"🎮"},{key:"series",name:"Series",icon:"📺"},{key:"movie",name:"Movies",icon:"🎬"},{key:"buecher",name:"Bücher",icon:"📚"},{key:"watchlist",name:"Watchlist",icon:"❤️"}]}},emits:["toggle","setCategory","addItem","navigateToStatistics","navigateToCalendar","navigateToFeatures","navigateToProfile","togglePlatformFilter","toggleGenreFilter","toggleAiringFilter","showLogin","showRegister","logout"],methods:{}},le={class:"sidebar-content"},ce={class:"sidebar-section"},ue={class:"sidebar-nav"},de=["onClick"],ge={class:"nav-icon"},fe={class:"nav-text"},ve={class:"nav-count"},me=["onClick","title"],pe={key:0,class:"sidebar-section"},he={class:"filter-section"},ye={class:"filter-group"},ke={class:"filter-checkboxes"},Ie=["value","onChange"],we={class:"option-text"},be={class:"filter-group"},Se={class:"filter-checkboxes"},Ce=["value","onChange"],Fe={class:"option-text"},_e={class:"filter-group"},xe={class:"filter-checkboxes"},Ae={class:"filter-option"},Le={class:"filter-option"},Me={class:"sidebar-section"},Ee={key:0,class:"auth-buttons"},Te={key:1,class:"user-info"},Ue={class:"user-profile"},$e={class:"profile-details"},Be={class:"user-name"};function Pe(o,t,c,f,v,u){const y=T("router-link"),m=T("VersionInfo");return h(),p("aside",{id:"sidebar",class:U(["sidebar",{collapsed:c.collapsed,open:c.mobileOpen}])},[n("div",{class:"sidebar-header",onClick:t[0]||(t[0]=l=>o.$emit("toggle"))},[...t[7]||(t[7]=[n("h2",null,"Media Library",-1),n("button",{class:"sidebar-toggle"},"☰",-1)])]),n("div",le,[n("div",ce,[t[13]||(t[13]=n("h3",null,"Browse",-1)),n("nav",ue,[(h(!0),p(x,null,A(c.categories,l=>(h(),p("div",{key:l.key,class:"nav-item"},[n("button",{class:U(["nav-btn",{active:c.currentCategory===l.key}]),onClick:I=>o.$emit("setCategory",l.key)},[n("span",ge,b(l.icon),1),n("span",fe,b(l.name),1),n("span",ve,b(c.categoryCounts[l.key]||0),1)],10,de),n("button",{class:"add-btn",onClick:I=>o.$emit("addItem",l.key),title:`Add ${l.name}`},[...t[8]||(t[8]=[n("span",{class:"add-icon"},"+",-1)])],8,me)]))),128)),F(y,{to:"/statistics",class:"nav-btn"},{default:_(()=>[...t[9]||(t[9]=[n("span",{class:"nav-icon"},"📊",-1),n("span",{class:"nav-text"},"Statistics",-1)])]),_:1}),F(y,{to:"/calendar",class:"nav-btn"},{default:_(()=>[...t[10]||(t[10]=[n("span",{class:"nav-icon"},"📅",-1),n("span",{class:"nav-text"},"Calendar",-1)])]),_:1}),F(y,{to:"/features",class:"nav-btn"},{default:_(()=>[...t[11]||(t[11]=[n("span",{class:"nav-icon"},"⚡",-1),n("span",{class:"nav-text"},"Features",-1)])]),_:1}),F(y,{to:"/profile",class:"nav-btn"},{default:_(()=>[...t[12]||(t[12]=[n("span",{class:"nav-icon"},"👤",-1),n("span",{class:"nav-text"},"Profile",-1)])]),_:1})])]),c.isLoggedIn?(h(),p("div",pe,[t[23]||(t[23]=n("h3",null,"Filters",-1)),n("div",he,[n("div",ye,[t[15]||(t[15]=n("h4",null,"Platforms",-1)),n("div",ke,[(h(!0),p(x,null,A(c.platforms,l=>(h(),p("label",{key:l,class:"filter-option"},[n("input",{type:"checkbox",value:l,onChange:I=>o.$emit("togglePlatformFilter",l,I.target.checked)},null,40,Ie),t[14]||(t[14]=n("span",{class:"checkmark"},null,-1)),n("span",we,b(l),1)]))),128))])]),n("div",be,[t[17]||(t[17]=n("h4",null,"Genres",-1)),n("div",Se,[(h(!0),p(x,null,A(c.genres,l=>(h(),p("label",{key:l,class:"filter-option"},[n("input",{type:"checkbox",value:l,onChange:I=>o.$emit("toggleGenreFilter",l,I.target.checked)},null,40,Ce),t[16]||(t[16]=n("span",{class:"checkmark"},null,-1)),n("span",Fe,b(l),1)]))),128))])]),n("div",_e,[t[22]||(t[22]=n("h4",null,"Series Status",-1)),n("div",xe,[n("label",Ae,[n("input",{type:"checkbox",value:"airing",onChange:t[1]||(t[1]=l=>o.$emit("toggleAiringFilter","airing",l.target.checked))},null,32),t[18]||(t[18]=n("span",{class:"checkmark"},null,-1)),t[19]||(t[19]=n("span",{class:"option-text"},[n("span",{class:"airing-indicator"},"●"),ee(" Airing ")],-1))]),n("label",Le,[n("input",{type:"checkbox",value:"finished",onChange:t[2]||(t[2]=l=>o.$emit("toggleAiringFilter","finished",l.target.checked))},null,32),t[20]||(t[20]=n("span",{class:"checkmark"},null,-1)),t[21]||(t[21]=n("span",{class:"option-text"},"Finished",-1))])])])])])):Z("",!0),n("div",Me,[t[25]||(t[25]=n("h3",null,"Account",-1)),c.isLoggedIn?(h(),p("div",Te,[n("div",Ue,[t[24]||(t[24]=n("div",{class:"profile-avatar"},[n("span",{class:"avatar-text"},"👤")],-1)),n("div",$e,[n("span",Be,b(c.userName),1)]),n("button",{class:"account-btn",onClick:t[5]||(t[5]=l=>o.$emit("navigateToProfile"))},"⚙️")]),n("button",{class:"auth-btn",onClick:t[6]||(t[6]=l=>o.$emit("logout"))},"Logout")])):(h(),p("div",Ee,[n("button",{class:"auth-btn",onClick:t[3]||(t[3]=l=>o.$emit("showLogin"))},"Login"),n("button",{class:"auth-btn",onClick:t[4]||(t[4]=l=>o.$emit("showRegister"))},"Register")]))])]),F(m)],2)}const Ve=$(ie,[["render",Pe],["__scopeId","data-v-0edb0d6d"]]);export{Ve as S,Ne as u};
