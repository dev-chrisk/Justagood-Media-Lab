import{d as $,r as f,c as p,p as h}from"./index-uLsN5JDP.js";class N{constructor(){this.isConnected={value:!1},this.listeners=new Map,this.pollingInterval=null,this.lastUpdate=null,this.pollingIntervalMs=2e3}connect(){if(this.pollingInterval)return;const l=localStorage.getItem("authToken"),c=localStorage.getItem("currentUser");if(!l||!c){console.log("Skipping realtime connection - user not authenticated");return}console.log("Starting polling for real-time updates"),this.isConnected.value=!0,this.lastUpdate=new Date,this.pollingInterval=setInterval(()=>{this.checkForUpdates()},this.pollingIntervalMs)}async checkForUpdates(){try{const l=localStorage.getItem("authToken"),c=localStorage.getItem("currentUser");if(!l||!c)return;const s=await fetch("https://teabubble.attrebi.ch/api/media",{headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"}});if(!s.ok){if(s.status===401){this.disconnect();return}throw new Error(`HTTP error! status: ${s.status}`)}const d=await s.json();d&&d.length>0&&(console.log("Polling found updates:",d.length,"items"),this.listeners.forEach((i,v)=>{try{i({type:"media_updated",items:d,count:d.length,timestamp:new Date().toISOString()})}catch(u){console.error(`Error in listener ${v}:`,u)}})),this.lastUpdate=new Date}catch(l){console.error("Polling error:",l)}}addListener(l,c){this.listeners.set(l,c)}removeListener(l){this.listeners.delete(l)}disconnect(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null),this.isConnected.value=!1}destroy(){this.disconnect(),this.listeners.clear()}}const I=new N,j=$("media",()=>{const o=f(v()),l=f("game"),c=f(""),s=f([]),d=f(!1),i=f(null);function v(){try{const e=localStorage.getItem("authToken"),t=localStorage.getItem("currentUser");if(!e||!t){const a=localStorage.getItem("mediaData");return a?JSON.parse(a):[]}return[]}catch(e){return console.error("Failed to load media from storage:",e),[]}}function u(){try{const e=localStorage.getItem("authToken"),t=localStorage.getItem("currentUser");(!e||!t)&&localStorage.setItem("mediaData",JSON.stringify(o.value))}catch(e){console.error("Failed to save media to storage:",e)}}const S=p(()=>o.value.length),k=p(()=>{const e={};return o.value.forEach(t=>{const a=t.category||"unknown";e[a]=(e[a]||0)+1}),e}),M=p(()=>{let e=[...o.value];if(l.value&&l.value!=="all"&&(e=e.filter(t=>l.value==="watchlist"?t.category==="watchlist"||t.isNew===!0:t.category===l.value)),c.value){const t=c.value.toLowerCase();e=e.filter(a=>{var r,n,g,y;return((r=a.title)==null?void 0:r.toLowerCase().includes(t))||((n=a.description)==null?void 0:n.toLowerCase().includes(t))||((g=a.genre)==null?void 0:g.toLowerCase().includes(t))||((y=a.platforms)==null?void 0:y.toLowerCase().includes(t))})}return s.value.forEach(t=>{t.type==="platform"?e=e.filter(a=>{var r;return(r=a.platforms)==null?void 0:r.toLowerCase().includes(t.value.toLowerCase())}):t.type==="genre"?e=e.filter(a=>{var r;return(r=a.genre)==null?void 0:r.toLowerCase().includes(t.value.toLowerCase())}):t.type==="airing"&&(t.value==="airing"?e=e.filter(a=>a.isAiring===!0):t.value==="finished"&&(e=e.filter(a=>a.isAiring===!1||a.isAiring===null)))}),e});async function m(){var e,t;d.value=!0,i.value=null;try{const a=localStorage.getItem("authToken"),r=localStorage.getItem("currentUser");if(a&&r)try{const n=await h.getMedia();o.value=n||[]}catch(n){console.warn("API load failed for logged in user:",n),o.value=[]}else{const n=v();if(n.length>0)o.value=n;else{const g=await h.getMedia();o.value=g||[],u()}}}catch(a){i.value=((t=(e=a.response)==null?void 0:e.data)==null?void 0:t.message)||a.message||"Failed to load media data",console.error("Failed to load media:",a)}finally{d.value=!1}}function U(e){l.value=e}function F(e){c.value=e}function C(e){s.value.some(a=>a.type===e.type&&a.value===e.value)||s.value.push(e)}function E(e){s.value=s.value.filter(t=>!(t.type===e.type&&t.value===e.value))}function T(){s.value=[]}async function x(e){try{const t=localStorage.getItem("authToken"),a=localStorage.getItem("currentUser");if(t&&a)try{const r=await h.addMediaItem(e);return await m(),r}catch(r){throw console.error("API save failed for logged in user:",r),r}else{const r={id:Date.now(),...e,__order:o.value.length};return o.value.push(r),u(),r}}catch(t){throw i.value=t.message||"Failed to add media item",t}}async function A(e,t){try{const a=localStorage.getItem("authToken"),r=localStorage.getItem("currentUser");if(a&&r)try{const n=await h.updateMediaItem(e,t);return await m(),n}catch(n){throw console.error("API update failed for logged in user:",n),n}else{const n=o.value.findIndex(g=>g.id===e);if(n!==-1)return o.value[n]={...o.value[n],...t},u(),o.value[n];throw new Error("Media item not found")}}catch(a){throw i.value=a.message||"Failed to update media item",a}}async function L(e){try{const t=localStorage.getItem("authToken"),a=localStorage.getItem("currentUser");if(t&&a)try{return await h.deleteMediaItem(e),await m(),!0}catch(r){throw console.error("API delete failed for logged in user:",r),r}else{const r=o.value.findIndex(n=>n.id===e);if(r!==-1)return o.value.splice(r,1),u(),!0;throw new Error("Media item not found")}}catch(t){throw i.value=t.message||"Failed to delete media item",t}}async function b(e){try{const t=localStorage.getItem("authToken"),a=localStorage.getItem("currentUser");if(t&&a)try{const r=await h.batchAddMediaItems(e);return await m(),r}catch(r){throw console.error("API batch add failed for logged in user:",r),r}else{const r=e.map((n,g)=>({id:Date.now()+g,...n,__order:o.value.length+g}));return o.value.push(...r),u(),{success:!0,stats:{created:r.length,failed:0,errors:[]}}}}catch(t){throw i.value=t.message||"Failed to add media items",t}}async function D(e){try{const t=localStorage.getItem("authToken"),a=localStorage.getItem("currentUser");if(t&&a)try{return await h.batchDeleteMediaItems(e),await m(),!0}catch(r){throw console.error("API batch delete failed for logged in user:",r),r}else return o.value=o.value.filter(r=>!e.includes(r.id)),u(),!0}catch(t){throw i.value=t.message||"Failed to delete media items",t}}async function P(){try{const e=localStorage.getItem("authToken"),t=localStorage.getItem("currentUser");e&&t?await h.saveMedia(o.value):u()}catch(e){console.error("Failed to save media:",e)}}function w(){i.value=null}function _(e){if(console.log("Processing real-time update:",e),e.type==="media_updated"&&e.items)e.items.forEach(t=>{const a=o.value.findIndex(r=>r.id===t.id);a!==-1?o.value[a]={...o.value[a],...t}:o.value.push(t)});else if(e.action==="created"||e.action==="updated"){const t=e.item,a=o.value.findIndex(r=>r.id===t.id);a!==-1?o.value[a]={...o.value[a],...t}:o.value.push(t)}else if(e.action==="deleted"){const t=o.value.findIndex(a=>a.id===e.id);t!==-1&&o.value.splice(t,1)}u()}function z(){const e=localStorage.getItem("authToken"),t=localStorage.getItem("currentUser");if(!e||!t){console.log("Skipping realtime initialization - user not authenticated");return}try{I.addListener("media-store",_),I.connect()}catch(a){console.error("Failed to initialize realtime updates:",a)}}function R(){I.removeListener("media-store")}return{mediaData:o,currentCategory:l,searchQuery:c,activeFilters:s,loading:d,error:i,totalItems:S,categoryCounts:k,filteredMedia:M,loadMedia:m,setCategory:U,setSearchQuery:F,addFilter:C,removeFilter:E,clearFilters:T,addMediaItem:x,updateMediaItem:A,deleteMediaItem:L,batchAddMediaItems:b,batchDeleteMediaItems:D,saveMedia:P,clearError:w,initializeRealtimeUpdates:z,cleanupRealtimeUpdates:R}});export{j as u};
